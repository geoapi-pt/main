<!DOCTYPE html>
<html>
<head>
   <meta charset="utf-8">
   <title>GEO API PT</title>
   <link rel="stylesheet" href="https://geoapi.pt/css/main.css">
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
</head>
<body>

<div id="header_wrap" class="outer">
   <header class="inner">
      <a id="forkme_banner" href="https://github.com/jfoclpf/geoapi.pt">Ver Documentação no GitHub</a>
      <h1 id="project_title">geoapi.pt</h1>
      <h2 id="project_tagline">Informação para Portugal sobre regiões administrativas oficiais, georreferenciação e códigos postais</h2>
      <a href="https://en.liberapay.com/joaopimentel1980">
         <img src="https://img.shields.io/liberapay/receives/joaopimentel1980.svg?logo=liberapay" alt="Donate with librepay">
      </a>
      <a href="https://en.liberapay.com/joaopimentel1980/donate">
         <img src="https://img.shields.io/badge/donate-Donate-yellow?logo=liberapay" alt="Donate with librepay">
      </a>
      <img src="https://img.shields.io/endpoint?url=https://geoapi.pt/shieldsio/requestsLastHour" alt="Requests on last hour">
      <img src="https://img.shields.io/endpoint?url=https://geoapi.pt/shieldsio/requestsLastDay" alt="Requests on last day">
   </header>
</div>

<div class="limiter" style="padding: 5% 10%;>
   <label for="select-municipio">Município</label>
   <select class="form-control" id="select-municipio"></select>
   <label for="select-freguesia">Junta de Freguesia</label>
   <select class="form-control" id="select-freguesia"></select><br>

   <table class="table">
     <tbody id="result">
     </tbody>
   </table>
</div>

<script>
   const geoApiUrl = 'https://geoapi.pt'

   const selectMunicipality = document.getElementById('select-municipio')
   const selectFreguesia = document.getElementById('select-freguesia')

   selectMunicipality.addEventListener('change', function() {
     fetch(`${geoApiUrl}/municipios/${this.value}/freguesias?json=1`).then(res => res.json())
       .then(function(res) {
         // clean select
         var length = selectFreguesia.options.length;
         for (var i = length - 1; i >= 0; i--) {
           selectFreguesia.options[i] = null;
         }

         res.freguesias.forEach(el => {
           selectFreguesia.options.add(new Option(el, el))
         })

         selectFreguesia.dispatchEvent(new Event('change'));
       })
       .catch(function(err) {
         console.error('error fetching freguesias', err)
       })
   })


   selectFreguesia.addEventListener('change', function() {
     fetch(`${geoApiUrl}/freguesia/${this.value}?municipio=${selectMunicipality.value}&json=1`).then(res => res.json())
       .then(function(res) {
         const result = document.getElementById('result')
         result.innerHTML = ''
         for (const el in res) {
           result.innerHTML += `<tr><th>${el}</th><td>${res[el]}</td></tr>`
         }
       })
       .catch(function(err) {
         console.error('error fetching freguesias', err)
       })
   })

   fetch(`${geoApiUrl}/municipios?json=1`).then(res => res.json())
     .then(function(municipios) {
       municipios.forEach(el => {
         selectMunicipality.options.add(new Option(el, el))
       })

       selectMunicipality.dispatchEvent(new Event('change'));
     })
     .catch(function(err) {
       console.error('error fetching municipios', err)
     })
</script>

</body>
</html>
